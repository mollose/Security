# 리버싱 핵심 원리

## 목차

<br/><br/>

* Win32 응용 프로그램에서는 API 함수의 파라미터를 스택을 이용하여 전달하는데, VC++ 사용 시 기본 문자열은 유니코드가 되고, 문자열 API 함수들도 유니코드 계열 함수로 변경됨
* Optional Header의 DLL Characteristics 멤버에서 0x0040은 Dynamic Base를 의미(Windows Vista부터 적용된 ASLR 기능 때문). 0x0000으로 패치함으로써 ASLR 기능 해제 가능
* 라이브러리와 헤더의 차이점 : 라이브러리는 기계어로 번역된 바이너리이며, 헤더 파일은 컴파일러가 컴파일 전 알아볼 수 있도록 프로그래밍 언어의 문법에 맞게 작성된 선언들의 집합. 라이브러리를 사용하기 위해서는 해당 라이브러리의 헤더 파일이 있어야 하는데, 컴파일러가 이러한 헤더 파일을 가지고 심볼 네임을 만들어 오브젝트 파일에 넣어주면, 링커가 해당 심볼 네임을 가지고 라이브러리를 뒤져 링크를 하게 됨

<br/><br/>

## 레지스터
극히 소량의 데이터나 처리 중인 중간 결과를 일시적으로 기억해두는 고속의 전용 영역. 아래는 IA-32 레지스터 중 Basic program execution register의 종류들

<br/>

### 32bit 범용 레지스터
* EAX : 주로 산술 연산에 사용. 함수의 리턴값이 저장됨
* EBX : 특정 주소를 저장하는데 사용. 간접 주소 지정자
* ECX : 반복적으로 실행되는 특정 명령에 사용. 반복 카운터
* EDX : 주로 EAX 보조로 사용되며, 일반적인 자료 저장, 입출력에 사용
* 각 레지스터들은 16bit 하위 호환을 위해 몇 개의 구획으로 나뉨(ex. AX(EAX의 하위 16bit), AH(AX의 상위 8bit), AL(AX의 하위 8bit))

<br/>

### 세그먼트 레지스터(16bits) 
IA-32 보호 모드에서 세그먼트란, 메모리를 조각내어 각 조각마다 시작 주소, 범위, 접근 권한 등을 부여해 메모리를 보호하는 기법을 말하며, 페이징 기법과 함께 가상 메모리를 실제 물리 메모리로 변경할 때 사용되기도 함. 세그먼트 메모리는 Segment Descriptor Table(SDT)에 기술되어 있는데, 세그먼트 레지스터는 SDT의 index를 저장
* CS(Code Segment) : 실행될 기계 명령어가 저장된 메모리 주소 지정
* DS(Data Segment) : 프로그램에서 정의된 데이터, 상수, 작업영역의 주소 지정
* SS(Stack Segment) : 프로그램이 임시로 저장할 필요가 있거나 함수 호출에 관련된 정보 저장
* ES, FS, GS(Extra Data Segment)
* 세그먼트 레지스터가 가리키는 세그먼트 디스크립터와 가상 메모리가 조합되어 선형 주소(Linear Address)가 되며, 페이징 기법에 의해 변환 과정을 거치거나, 페이징을 사용하지 않을 시엔, 그대로 물리 주소로 바뀌게 됨

<br/>

### 포인터 레지스터(32bits)
* EIP : 다음 실행될 명령어의 주소가 저장됨(프로그램 카운터. 범용 레지스터들과 달리 직접 값을 변경할 수 없기 때문에, 다른 명령어를 사용해 간접적으로 변경시켜야 함(특정 명령어(JMP, Jcc, CALL, RET 등) 사용 혹은 인터럽트, 예외의 발생)). EIP에 저장된 주소의 명령어를 하나 처리하고, 자동으로 명령어 길이만큼 EIP 길이 증가
* EBP : SS 레지스터와 함께 사용. 스택 프레임의 기준점 주소
* ESP : SS 레지스터와 함께 사용. 스택의 가장 끝 주소 가리킴
* ESP는 스택 메모리에서의 현재 위치를 가리키며, EBP는 함수 호출 시 그 순간의 ESP를 저장하고 있다가 함수가 리턴하기 직전에 ESP에 값을 되돌려줌으로써 스택이 깨지지 않도록 함(Stack Frame 기법)

<br/>

### 인덱스 레지스터(32bits) 
특정 명령어들(LODS, STOS, REP MOVS 등)과 함께 주로 메모리 복사에 사용
* EDI : 목적지(사본 주소)에 대한 값 저장
* ESI : 출발지(원본 주소)에 대한 값 저장

<br/>

### 플래그 레지스터(32bits)
EFLAGS(FLAGS 레지스터의 32bit 확장형으로, 연산 결과 및 시스템 상태와 관련된 플래그값 저장). 일부 비트는 시스템에서 직접 세팅하고 일부 비트는 프로그램에서 사용된 명령의 수행 결과에 따라 세팅됨
* ZF(Zero Flag) : 연산 후 결과값이 0일 시 1로 세팅
* OF(Overflow Flag) : 부호 있는 수의 오버플로 발생, 혹은 MSB 변경 시 1로 세팅
* CF(Carry Flag) : 부호 없는 수의 오버플로 발생 시 1로 세팅
